package com.api.workflow.util;

import java.util.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import weaver.conn.RecordSet;
import weaver.general.Util;
import weaver.systeminfo.SystemEnv;
import com.api.workflow.bean.SearchConditionOption;

public class ServiceUtil {
	private static Map<String,Boolean> spaconfig = new HashMap<String,Boolean>();
	
	/**
	 * 接口中文都需特殊字符转译，否则前端response.json()会报错
	 */
	public static String convertChar(String str){
		str = str.replace("\t", "");
		str = str.replace("\r", "");
		str = str.replace("\n", "");
		str = str.replace("\f", "");
		//str = str.replace("\\", "\\\\");
		return str;
	}
	
	/**
	 * String转Int，默认为0
	 */
	public static int convertInt(String str){
		return Util.getIntValue(str, 0);
	}
	
	/**
	 * 相关请求增加session信息
	 */
	public static void addRelatedWfSession(HttpServletRequest request, String relatedrequestids) {
		HttpSession session = request.getSession();
		for(String relatedrequestid : relatedrequestids.split(",")){
			int tempnum = Util.getIntValue(String.valueOf(session.getAttribute("slinkwfnum")));
			tempnum++;
			session.setAttribute("resrequestid" + tempnum, relatedrequestid);
			session.setAttribute("slinkwfnum", "" + tempnum);
		}
		session.setAttribute("haslinkworkflow", "1");
	}
	
	/**
	 * 根据用户配置清除缓存
	 */
	public static void removeSpaConfig(int userid){
		//spaconfig.remove(userid+"_wfformspamodle");
		spaconfig.remove(userid+"_wfspaopenwindow");
	}
	
	
	/**
	 * 根据用户判断是否开启SPA模式
	 */
	/*public static boolean judgeOpenSpaModle(int userid){
		boolean openspa = false;
		String key = userid+"_wfformspamodle";
		if(spaconfig.containsKey(key))
			return spaconfig.get(key);
		else{
			rs.executeSql("select wfformspamodle from workflow_RequestUserDefault where userid="+userid);
			if(rs.next() && "1".equals(rs.getString(1)))
				openspa = true;
			spaconfig.put(key, openspa);
			return openspa;
		}
	}*/
	
	/**
	 * 根据用户判断是否SPA下弹窗打开
	 */
	public static boolean judgeSpaOpenWindow(int userid){
		RecordSet rs = new RecordSet();
		boolean openwindow = true;
		String key = userid+"_wfspaopenwindow";
		if(spaconfig.containsKey(key))
			return spaconfig.get(key);
		else{
			rs.executeSql("select wfspaopenwindow from workflow_RequestUserDefault where userid="+userid);
			if(rs.next() && !"1".equals(rs.getString(1)))
				openwindow = false;
			spaconfig.put(key, openwindow);
			return openwindow;
		}
	}
	
	/**
	 * 判断SPA模式下是否请求到路由或原地址
	 * @return true:请求路径地址   false：请求原地址
	 */
	public static boolean judgeWfFormReqRoute(String requestid, String workflowid, String nodeid, int userid, String isremark){
		RecordSet rs = new RecordSet();
		if("1".equals(isremark) || "8".equals(isremark) || "9".equals(isremark)){		//抄送、转发需计算是否是某节点操作者
			rs.executeSql("select isprocessed,isremark,userid,nodeid from workflow_currentoperator where requestid = "
					+ requestid + " and userid="+userid+" order by receivedate desc, receivetime desc");
			while (rs.next()) {
				String isremark_tmp = Util.null2String(rs.getString("isremark"));
				if("0".equals(isremark_tmp)) {
					int nodeid_tmp = Util.getIntValue(rs.getString("nodeid"), 0);
					if (nodeid_tmp != 0) {
						isremark = "0";
						nodeid = nodeid_tmp+"";
						break;
					}
				}
			}
		}
		boolean reqRoute = nodeSupportSPA(nodeid);
		//待办暂只支持只读字段
		if(reqRoute && ("0".equals(isremark) || "5".equals(isremark))){
			rs.executeSql("select count(1) from workflow_nodeform where nodeid="+nodeid+" and isedit=1");
			if(rs.next() && rs.getInt(1) > 0)
				reqRoute = false;
		}
		return reqRoute;
	}
	
	/**
	 * 根据节点判断是否支持SPA模式
	 */
	public static boolean nodeSupportSPA(String nodeid){
		boolean supportSPA = false;
		boolean supportNormal = false;		//SPA模式支持普通模板
		boolean suppoerE7Layout = false;	//SPA模式支持E7源码模板
		RecordSet rs = new RecordSet();
		int ismode = 0;
		rs.executeSql("select ismode from workflow_flownode where nodeid="+nodeid);
		if(rs.next())
			ismode = Util.getIntValue(rs.getString("ismode"));
		if(supportNormal && ismode == 0){
			supportSPA = true;
		}else if(ismode == 2){
			rs.executeSql("select version from workflow_nodehtmllayout where nodeid="+nodeid+" and type=0 and isactive=1 order by id desc");
			if(rs.next()){
				int version = rs.getInt(1);
				if(version == 2 || (suppoerE7Layout && (version == 0 || version == 1)))
					supportSPA = true;
			}
		}
		return supportSPA;
	}
	
}
